<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Interfaz Gestual PRO – FIX CALIBRACIÓN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
body{background:black;overflow:hidden}
video,canvas{position:fixed;inset:0;width:100%;height:100%;object-fit:cover}
video{transform:scaleX(-1)}
canvas{pointer-events:none}
.panel{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  background:rgba(0,140,255,.35);backdrop-filter:blur(14px);
  padding:10px 18px;border-radius:14px;font-weight:600;color:black
}
</style>
</head>

<body>
<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>
<div class="panel" id="panel">CALIBRANDO…</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const panel=document.getElementById("panel");

function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();addEventListener("resize",resize);

/* ===== STATE ===== */
let sx=.5, sy=.5;
const smooth=(p,c)=>p*0.8+c*0.2;

/* ===== CALIBRATION (TIME BASED) ===== */
let minX=1,maxX=0,minY=1,maxY=0;
let calibrated=false;
const CALIBRATION_TIME=3000; // 3 segundos
let calibStart=null;

/* ===== HANDS ===== */
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(res=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!res.multiHandLandmarks?.[0]?.[8]) return;

  const p=res.multiHandLandmarks[0][8];
  const now=performance.now();

  /* ===== CALIBRATION ===== */
  if(!calibrated){
    if(!calibStart) calibStart=now;

    minX=Math.min(minX,p.x);
    maxX=Math.max(maxX,p.x);
    minY=Math.min(minY,p.y);
    maxY=Math.max(maxY,p.y);

    if(now-calibStart>CALIBRATION_TIME){
      // fallback seguro
      if(maxX-minX<0.05){minX=0;maxX=1}
      if(maxY-minY<0.05){minY=0;maxY=1}

      calibrated=true;
      panel.textContent="LISTO";
    }
    return;
  }

  /* ===== NORMALIZE ===== */
  let x=(p.x-minX)/(maxX-minX);
  let y=(p.y-minY)/(maxY-minY);
  x=Math.min(1,Math.max(0,1-x));
  y=Math.min(1,Math.max(0,y));

  sx=smooth(sx,x);
  sy=smooth(sy,y);

  drawCursor(sx,sy);
});

/* ===== CAMERA ===== */
new Camera(video,{
  onFrame:async()=>{await hands.send({image:video});},
  width:1280,height:720
}).start();

/* ===== DRAW ===== */
function drawCursor(x,y){
  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(x*canvas.width,y*canvas.height,12,0,Math.PI*2);
  ctx.fill();
}
</script>
</body>
</html>
